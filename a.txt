import dayjs from 'dayjs';
dayjs().format()

import express from 'express';
import cors from 'cors';
import {MongoClient, ObjectId} from 'mongodb';


console.log(dayjs().format("hh:mm:ss"));

const client = new MongoClient("mongodb://127.0.0.1:27017");

let db;
client.connect().then(() => {
    db = client.db("uol_chat_db");
});


const app = express();
app.use(express.json());
app.use(cors());



app.post("/participants", async (req, res) => {
    const user = {...req.body, lastStatus: Date.now()};
    const messageBody ={
        from: user.name,
        to: 'Todos',
        text: 'entra na sala...',
        type: 'status',
        time: dayjs().format("hh:mm:ss")
    };
    
    if(!user.name || user.name==="") return res.status(422).send("O nome de usuário deve ser informado.");
    const participants = await db.collection("participants").find().toArray();
    if(participants.find((participant) => participant.name == user.name)) return res.status(409).send("Este nome de usuário já existe.");
   //updateParticipants();
    try{
        await db.collection("participants").insertOne(user);
        await db.collection("messages").insertOne(messageBody);
      //  setInterval(updateParticipants, 15000);
        res.status(201).send("OK"); 
    }
    catch (error){
        res.status(400).send("Error");
    }

});


async function updateParticipants() {
    
    try{
        const participantsList = await db.collection("participants").findMany().toArray();
     //   console.log(participantsList);
        for (let count = 0; count < participantsList.length; count++){
            participant = participantsList[count];
            const currentTime = Date.now();
            const messageBody ={
                from: participant.name,
                to: 'Todos',
                text: 'sai na sala...',
                type: 'status',
                time: dayjs().format("hh:mm:ss")
            };
            console.log(participant.lastStatus);
            console.log(participant);
            if(currentTime - participant.lastStatus > 10000){
                await db.collection("participants").deleteOne({name: participant.name});
                await db.collection("messages").insertOne(messageBody);
                console.log(`participante ${participant.name} removido`)
            }
        }
    } catch(error){

    }
}


app.get("/participants", async (req, res) =>{
    try{
        const participantsList = await db.collection("participants").find().toArray();
        res.send(participantsList);
    } catch(error){
        res.status(400).send("Error!");
    }

});

app.post("/messages", async (req, res) => {
    const message = {...req.body, from: req.headers.user, time: dayjs().format("hh:mm:ss")}
    try{
        await db.collection("messages").insertOne(message);
         console.log(message);
        res.status(201).send("OK");
    } catch(error){
        res.status(400).send(error);
    }
});


app.get("/messages", async (req, res) => {
    const limit = parseInt(req.query["limit"]);
    let contMessages = 0;
    const newMessagesList = [];
    const user = req.headers.user;
    try{
        const messagesList = await db.collection("messages").find().toArray();
        //const messagesList = await db.collection("messages").find({to: user}).toArray();
        if(!limit) res.send(messagesList);
        for(let count = messagesList.length-1; count >= 0; count--){
            const message = messagesList[count];
            if(message.type === "message" || message.from === user || message.to === user){
                newMessagesList.unshift(message);
                contMessages++;
            }
            if(contMessages === limit)
                break;
        }
        res.send(newMessagesList);


    } catch(error){

    }

});

app.post("/status", async (req, res) => {
    const userName = req.headers.user;
    const participant = await db.collection("participants").findOne({name: userName});
    if(!participant) {
        console.log("não atualizado, participante removido");
        return res.sendStatus(404);
    }
    const participantID = participant._id;    
    try{

        await db.collection('participants').updateOne(
            {
                _id: ObjectId(participantID)
            },
            {
                $set: {
                    lastStatus: Date.now()
                }
            }
        );
       // console.log("status atualizado");
        res.sendStatus(200);
    } catch(error){
        res.send(400);
    }
});

app.listen(5000, ()=> console.log("servidor rodando"));
